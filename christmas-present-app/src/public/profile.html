<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <link rel="icon" href="santa-hat.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>
  <script src="nav.js"></script>
  <script src="snow.js"></script>
</head>
<body>
  <div id="nav"></div>
  <h1>User Profile</h1>
  <p id="name"></p>
  <button id="editNameBtn">Edit Name</button>
  <p id="email"></p>
  <button id="editEmailBtn">Edit Email</button>
  <p id="role"></p>
  <p id="rolePending" style="display:none;"></p>
  <button id="requestRoleBtn" style="display:none;">Request Role</button>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session) {
        window.location.href = 'login.html';
        return;
      }
      const user = data.session.user;

      document.getElementById('email').textContent = `Email: ${user.email}`;

      const { data: profile } = await supabaseClient
        .from('profiles')
        .select('role, role_pending')
        .eq('id', user.id)
        .single();

      let currentProfile = profile;
      let canRequestRole = false;
      const requestBtn = document.getElementById('requestRoleBtn');
      if (currentProfile) {
        document.getElementById('role').textContent = `Role: ${profile.role}`;
        if (profile.role_pending) {
          const rpEl = document.getElementById('rolePending');
          rpEl.textContent = `Pending Role: ${profile.role_pending}`;
          rpEl.style.display = 'block';
        }
        requestBtn.style.display = 'block';
        if (!currentProfile.role_pending) {
          if (currentProfile.role === 'user') {
            requestBtn.textContent = 'Request Manager Role';
            canRequestRole = true;
          } else if (currentProfile.role === 'manager') {
            requestBtn.textContent = 'Request Admin Role';
            canRequestRole = true;
          }
        }
        if (!canRequestRole) {
          requestBtn.classList.add('inactive-btn');
        }

        const { data: person } = await supabaseClient
          .from('person')
          .select('name')
          .eq('user_profile', user.id)
          .maybeSingle();
        if (person) {
          document.getElementById('name').textContent = `Name: ${person.name}`;
        } else {
          document.getElementById('name').textContent = 'Name: (not set)';
        }
      }

      document.getElementById('editNameBtn').addEventListener('click', async () => {
        const newName = prompt('Enter new name:');
        if (!newName) return;
        await supabaseClient.from('person').update({ name: newName }).eq('user_profile', user.id);
        document.getElementById('name').textContent = `Name: ${newName}`;
      });

      document.getElementById('editEmailBtn').addEventListener('click', async () => {
        const newEmail = prompt('Enter new email:');
        if (!newEmail) return;
        const { error } = await supabaseClient.auth.updateUser({ email: newEmail });
        if (error) {
          alert(error.message);
          return;
        }
        document.getElementById('email').textContent = `Email: ${newEmail}`;
      });

      if (canRequestRole) {
        requestBtn.addEventListener('click', async () => {
          let desired = 'manager';
          if (currentProfile && currentProfile.role === 'manager') {
            desired = 'admin';
          }
          const { error } = await supabaseClient
            .from('profiles')
            .update({ role_pending: desired })
            .eq('id', user.id);
          if (error) {
            alert(error.message);
            return;
          }
          const rpEl = document.getElementById('rolePending');
          rpEl.textContent = `Pending Role: ${desired}`;
          rpEl.style.display = 'block';
          currentProfile.role_pending = desired;
          document.getElementById('requestRoleBtn').style.display = 'none';
        });
      } else {
        requestBtn.addEventListener('click', () => {
          alert("You can't perform this action right now.");
        });
      }
    });
  </script>
</body>
</html>
