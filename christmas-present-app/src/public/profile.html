<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>
  <script src="nav.js"></script>
  <script src="snow.js"></script>
</head>
<body>
  <div id="nav"></div>
  <h1>User Profile</h1>
  <p id="name"></p>
  <button id="editNameBtn">Edit Name</button>
  <p id="email"></p>
  <button id="editEmailBtn">Edit Email</button>
  <p id="role"></p>
  <p id="rolePending" style="display:none;"></p>
  <button id="requestRoleBtn" style="display:none;">Request Role</button>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session) {
        window.location.href = 'login.html';
        return;
      }
      const user = data.session.user;

      document.getElementById('email').textContent = `Email: ${user.email}`;

      const { data: profile } = await supabaseClient
        .from('profiles')
        .select('role, role_pending, person_id')
        .eq('id', user.id)
        .single();

      let currentProfile = profile;
      if (currentProfile) {
        document.getElementById('role').textContent = `Role: ${profile.role}`;
        if (profile.role_pending) {
          const rpEl = document.getElementById('rolePending');
          rpEl.textContent = `Pending Role: ${profile.role_pending}`;
          rpEl.style.display = 'block';
        }
        const requestBtn = document.getElementById('requestRoleBtn');
        if (!currentProfile.role_pending) {
          if (currentProfile.role === 'user') {
            requestBtn.textContent = 'Request Manager Role';
            requestBtn.style.display = 'block';
          } else if (currentProfile.role === 'manager') {
            requestBtn.textContent = 'Request Admin Role';
            requestBtn.style.display = 'block';
          }
        }

        if (currentProfile.person_id) {
          const { data: person } = await supabaseClient
            .from('person')
            .select('name')
            .eq('id', currentProfile.person_id)
            .maybeSingle();
          if (person) {
            document.getElementById('name').textContent = `Name: ${person.name}`;
          } else {
            document.getElementById('name').textContent = 'Name: (not set)';
          }
        } else {
          const { data: person } = await supabaseClient
            .from('person')
            .select('name')
            .eq('user_profile', user.id)
            .maybeSingle();
          if (person) {
            document.getElementById('name').textContent = `Name: ${person.name}`;
          } else {
            document.getElementById('name').textContent = 'Name: (not set)';
          }
        }
      }

      document.getElementById('editNameBtn').addEventListener('click', async () => {
        const newName = prompt('Enter new name:');
        if (!newName) return;
        if (currentProfile && currentProfile.person_id) {
          await supabaseClient.from('person').update({ name: newName }).eq('id', currentProfile.person_id);
        } else {
          await supabaseClient.from('person').update({ name: newName }).eq('user_profile', user.id);
        }
        document.getElementById('name').textContent = `Name: ${newName}`;
      });

      document.getElementById('editEmailBtn').addEventListener('click', async () => {
        const newEmail = prompt('Enter new email:');
        if (!newEmail) return;
        const { error } = await supabaseClient.auth.updateUser({ email: newEmail });
        if (error) {
          alert(error.message);
          return;
        }
        document.getElementById('email').textContent = `Email: ${newEmail}`;
      });

      document.getElementById('requestRoleBtn').addEventListener('click', async () => {
        let desired = 'manager';
        if (currentProfile && currentProfile.role === 'manager') {
          desired = 'admin';
        }
        const { error } = await supabaseClient
          .from('profiles')
          .update({ role_pending: desired })
          .eq('id', user.id);
        if (error) {
          alert(error.message);
          return;
        }
        const rpEl = document.getElementById('rolePending');
        rpEl.textContent = `Pending Role: ${desired}`;
        rpEl.style.display = 'block';
        currentProfile.role_pending = desired;
        document.getElementById('requestRoleBtn').style.display = 'none';
      });
    });
  </script>
</body>
</html>
