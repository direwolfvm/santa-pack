<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>People</title>
  <link rel="icon" href="santa-hat.svg" type="image/svg+xml">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>
  <script src="nav.js"></script>
  <script src="snow.js"></script>
</head>
<body>
  <div id="nav"></div>
  <h1 id="title">People</h1>
  <p id="instructions">Select your name below or add yourself.</p>
  <div id="peopleContainer">Loading...</div>

  <div id="addPersonSection">
    <h2>Add Person</h2>
    <form id="personForm">
      <label for="personSelect">Person:</label>
      <select id="personSelect" required></select>
      <button type="submit">Add Person</button>
    </form>
  </div>
    <script>
      const params = new URLSearchParams(window.location.search);
      const familyId = params.get('familyId');
      const familyName = params.get('familyName');
      const giftRoundId = params.get('giftRoundId');
      const giftRoundStage = params.get('stage');

      async function init() {
        const { data: sessionData } = await supabaseClient.auth.getSession();
        if (!sessionData.session) {
          window.location.href = 'login.html';
          return;
        }
        const userId = sessionData.session.user.id;
        const token = sessionData.session.access_token;
        const [{ data: membership }, { data: profile }] = await Promise.all([
          supabaseClient
            .from('person')
            .select('id')
            .eq('family', familyId)
            .eq('user_profile', userId)
            .maybeSingle(),
          supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', userId)
            .maybeSingle()
        ]);
        if (!membership) {
          window.location.href = 'index.html';
          return;
        }
        const role = profile ? profile.role : null;
        const canManage = role === 'manager' || role === 'admin';
        if (!canManage) {
          document.getElementById('addPersonSection').style.display = 'none';
        }

        async function loadAvailablePersons() {
          const { data: candidates } = await supabaseClient
            .from('person')
            .select('user_profile, name')
            .is('family', null)
            .is('family_pending', null);
          const select = document.getElementById('personSelect');
          select.innerHTML = '';
          (candidates || []).forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.user_profile;
            opt.textContent = c.name;
            select.appendChild(opt);
          });
        }

        async function setTitle() {
          const res = await fetch(`/api/families/${familyId}/gift-rounds`);
          const rounds = await res.json();
          const round = rounds.find(r => String(r.id) === String(giftRoundId));
          const name = round ? round.name : 'Gift Round';
          document.title = `People - ${name}`;
          document.getElementById('title').textContent = `People for ${name}`;
        }

        async function loadPeople() {
          const res = await fetch(`/api/families/${familyId}/people`);
          const people = await res.json();
          const container = document.getElementById('peopleContainer');
          container.innerHTML = '';
          if (people.length === 0) {
            container.textContent = 'No people yet. Add someone below.';
            return;
          }

          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const headRow = document.createElement('tr');
          ['Name', 'Action'].forEach(t => {
            const th = document.createElement('th');
            th.textContent = t;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          people.forEach(p => {
            const row = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.textContent = p.name;
            row.appendChild(nameTd);

            const actionTd = document.createElement('td');
            const btn = document.createElement('button');
            btn.classList.add('table-btn');
            btn.textContent = giftRoundStage === 'guessing' ? 'Guess' : 'Give';
            btn.addEventListener('click', () => {
              const page = giftRoundStage === 'guessing' ? 'guesses.html' : 'presents.html';
              window.location.href = `${page}?familyId=${familyId}&familyName=${encodeURIComponent(familyName)}&giftRoundId=${giftRoundId}&personId=${p.id}&personName=${encodeURIComponent(p.name)}&stage=${encodeURIComponent(giftRoundStage)}`;
            });
            actionTd.appendChild(btn);
            row.appendChild(actionTd);
            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          container.appendChild(table);
        }

        if (canManage) {
          await loadAvailablePersons();
          document.getElementById('personForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user_profile = document.getElementById('personSelect').value;
            await fetch(`/api/families/${familyId}/people`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ user_profile })
            });
            await loadPeople();
            await loadAvailablePersons();
          });
        }

        setTitle();
        loadPeople();
      }

      init();
    </script>
</body>
</html>
