<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Management Console</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>
  <script src="nav.js"></script>
  <script src="snow.js"></script>
</head>
<body>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session) {
        window.location.href = 'login.html';
        return;
      }
      const { data: profile } = await supabaseClient
        .from('profiles')
        .select('role')
        .eq('id', data.session.user.id)
        .maybeSingle();
      if (!profile || profile.role !== 'admin') {
        window.location.href = 'index.html';
        return;
      }
      loadData();
    });
  </script>
  <div id="nav"></div>
  <h1>Management Console</h1>

  <h2>Families</h2>
  <div id="familiesTable">Loading...</div>

  <h2>Gift Rounds</h2>
  <div id="roundsTable">Loading...</div>

  <h2>People</h2>
  <div id="peopleTable">Loading...</div>

  <h2>Presents</h2>
  <div id="presentsTable">Loading...</div>

<script>
async function loadData() {
  const families = await fetch('/api/families').then(r => r.json());
  const famMap = {};
  families.forEach(f => { famMap[f.id] = f.name; });

  const famCont = document.getElementById('familiesTable');
  famCont.innerHTML = '';
  const famTable = document.createElement('table');
  const famHead = document.createElement('tr');
  ['ID','Name','Delete'].forEach(t => { const th=document.createElement('th'); th.textContent=t; famHead.appendChild(th); });
  const famThead = document.createElement('thead');
  famThead.appendChild(famHead);
  famTable.appendChild(famThead);
  const famBody = document.createElement('tbody');
  families.forEach(f => {
    const row=document.createElement('tr');
    row.innerHTML = `<td>${f.id}</td><td>${f.name}</td>`;
    const delTd=document.createElement('td');
    const btn=document.createElement('button');
    btn.textContent='Delete';
    btn.addEventListener('click',()=>{fetch(`/api/families/${f.id}`,{method:'DELETE'}).then(loadData);});
    delTd.appendChild(btn);
    row.appendChild(delTd);
    famBody.appendChild(row);
  });
  famTable.appendChild(famBody);
  famCont.appendChild(famTable);

  // Gift rounds
  const rounds = [];
  for (const f of families) {
    const rs = await fetch(`/api/families/${f.id}/gift-rounds`).then(r => r.json());
    rs.forEach(rnd => rounds.push({...rnd, familyName:f.name}));
  }
  const roundCont=document.getElementById('roundsTable');
  roundCont.innerHTML='';
  const roundTable=document.createElement('table');
  const rHead=document.createElement('tr');
  ['ID','Name','Family','Stage','Delete'].forEach(t=>{const th=document.createElement('th');th.textContent=t;rHead.appendChild(th);});
  const rThead=document.createElement('thead');rThead.appendChild(rHead);roundTable.appendChild(rThead);
  const rBody=document.createElement('tbody');
  rounds.forEach(r=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${r.id}</td><td>${r.name}</td><td>${r.familyName}</td><td>${r.stage}</td>`;
    const delTd=document.createElement('td');
    const btn=document.createElement('button');
    btn.textContent='Delete';
    btn.addEventListener('click',()=>{fetch(`/api/families/gift-rounds/${r.id}`,{method:'DELETE'}).then(loadData);});
    delTd.appendChild(btn);
    row.appendChild(delTd);
    rBody.appendChild(row);
  });
  roundTable.appendChild(rBody);
  roundCont.appendChild(roundTable);

  // People
  const people=[];
  for (const f of families) {
    const ps = await fetch(`/api/families/${f.id}/people`).then(r => r.json());
    ps.forEach(p=>people.push({...p, familyName:f.name}));
  }
  const profileIds = people.filter(p => p.user_profile).map(p => p.user_profile);
  let profiles = [];
  if (profileIds.length > 0) {
    const { data: profData } = await supabaseClient
      .from("profiles")
      .select("id, role, role_pending")
      .in("id", profileIds);
    profiles = profData || [];
  }
  const profileMap = {};
  profiles.forEach(pr => { profileMap[pr.id] = pr; });
  const peopleCont=document.getElementById('peopleTable');
  peopleCont.innerHTML='';
  const peopleTable=document.createElement('table');
  const pHead=document.createElement('tr');
  ['ID','Name','Family','Role','Pending','Confirm','Delete'].forEach(t=>{const th=document.createElement('th');th.textContent=t;pHead.appendChild(th);});
  const pThead=document.createElement('thead');pThead.appendChild(pHead);peopleTable.appendChild(pThead);
  const pBody=document.createElement('tbody');
  people.forEach(p=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${p.id}</td><td>${p.name}</td><td>${p.familyName}</td>`;
    const roleTd=document.createElement('td');
    const prof=profileMap[p.user_profile]||{};
    roleTd.textContent=prof.role||'';
    row.appendChild(roleTd);
    const pendTd=document.createElement('td');
    pendTd.textContent=prof.role_pending||'';
    row.appendChild(pendTd);
    const confirmTd=document.createElement('td');
    if(prof.role_pending){
      const cBtn=document.createElement('button');
      cBtn.textContent='Confirm';
      cBtn.addEventListener('click',async()=>{
        await supabaseClient.from("profiles")
          .update({role:prof.role_pending,role_pending:null})
          .eq('id',p.user_profile);
        loadData();
      });
      confirmTd.appendChild(cBtn);
    }
    row.appendChild(confirmTd);
    const delTd=document.createElement('td');
    const btn=document.createElement('button');
    btn.textContent='Delete';
    btn.addEventListener('click',()=>{fetch(`/api/families/people/${p.id}`,{method:'DELETE'}).then(loadData);});
    delTd.appendChild(btn);
    row.appendChild(delTd);
    pBody.appendChild(row);
  });
  peopleTable.appendChild(pBody);
  peopleCont.appendChild(peopleTable);

  // Presents
  const presents = await fetch('/api/presents').then(r=>r.json());
  const personMap = {};
  people.forEach(p=>{personMap[p.id]=p.name;});
  const roundMap = {};
  rounds.forEach(r=>{roundMap[r.id]=`${r.name} (${r.familyName})`;});
  const presCont=document.getElementById('presentsTable');
  presCont.innerHTML='';
  const presTable=document.createElement('table');
  const presHead=document.createElement('tr');
  ['ID','Name','Gift Round','Giver','Receiver','Delete'].forEach(t=>{const th=document.createElement('th');th.textContent=t;presHead.appendChild(th);});
  const presThead=document.createElement('thead');presThead.appendChild(presHead);presTable.appendChild(presThead);
  const presBody=document.createElement('tbody');
  presents.forEach(pr=>{
    const row=document.createElement('tr');
    const giver=pr.giver?personMap[pr.giver]||pr.giver:'';
    const receiver=pr.receiver?personMap[pr.receiver]||pr.receiver:'';
    const rnd=pr.gift_round?roundMap[pr.gift_round]||pr.gift_round:'';
    row.innerHTML=`<td>${pr.id}</td><td>${pr.name}</td><td>${rnd}</td><td>${giver}</td><td>${receiver}</td>`;
    const delTd=document.createElement('td');
    const btn=document.createElement('button');
    btn.textContent='Delete';
    btn.addEventListener('click',()=>{fetch(`/api/presents/${pr.id}`,{method:'DELETE'}).then(loadData);});
    delTd.appendChild(btn);
    row.appendChild(delTd);
    presBody.appendChild(row);
  });
  presTable.appendChild(presBody);
  presCont.appendChild(presTable);
}


</script>
</body>
</html>
