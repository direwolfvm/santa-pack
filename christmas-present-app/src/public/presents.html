<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Presents</title>
  <link rel="stylesheet" href="styles.css">
  <script src="nav.js"></script>
</head>
<body>
  <div id="nav"></div>
  <h1 id="title">Presents</h1>

  <h2>Your Presents</h2>
  <table border="1">
    <thead>
      <tr>
        <th>Receiver</th>
        <th>Name</th>
        <th>Description</th>
        <th>Cloaked Name</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="presentsTableBody"></tbody>
  </table>

  <script>
    const params = new URLSearchParams(window.location.search);
    const familyId = params.get('familyId');
    const giftRoundId = params.get('giftRoundId');
    const giverId = params.get('personId');
    const giverName = params.get('personName');

    document.getElementById('title').textContent = `Presents for ${giverName}`;

    async function loadPeople() {
      const res = await fetch(`/api/families/${familyId}/people`);
      let people = await res.json();
      people = people.filter(p => p.id !== parseInt(giverId, 10));
      loadPresents(people);
    }

    async function loadPresents(people) {
      const body = document.getElementById('presentsTableBody');
      body.innerHTML = '';
      for (const p of people) {
        const res = await fetch(`/api/presents?giver=${giverId}&receiver=${p.id}&giftRoundId=${giftRoundId}`);
        const data = await res.json();
        const present = data[0] || {};

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.name}</td>
          <td><input data-field="name" value="${present.name || ''}"></td>
          <td><input data-field="description" value="${present.description || ''}"></td>
          <td><input data-field="cloaked" value="${present.cloaked_name || ''}"></td>
          <td><button data-id="${present.id || ''}" data-receiver="${p.id}">Save</button></td>
        `;
        body.appendChild(row);
      }
    }

    document.getElementById('presentsTableBody').addEventListener('click', async (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const row = e.target.closest('tr');
      const receiverId = e.target.dataset.receiver;
      const id = e.target.dataset.id;
      const name = row.querySelector('input[data-field="name"]').value;
      const description = row.querySelector('input[data-field="description"]').value;
      const cloaked = row.querySelector('input[data-field="cloaked"]').value;

      if (id) {
        await fetch(`/api/presents/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description, cloakedName: cloaked })
        });
      } else {
        const res = await fetch('/api/presents', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description, cloakedName: cloaked, giver: giverId, receiver: receiverId, giftRoundId })
        });
        const created = await res.json();
        if (created && created[0]) {
          e.target.dataset.id = created[0].id;
        }
      }
    });

    loadPeople();
  </script>
</body>
</html>
